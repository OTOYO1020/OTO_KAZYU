{
    "id": "openstack%2Fglance~master~I5c11ad4b9f7f321a3d1cab71e34c2a6707ef1b5e",
    "project": "openstack/glance",
    "branch": "master",
    "hashtags": [],
    "change_id": "I5c11ad4b9f7f321a3d1cab71e34c2a6707ef1b5e",
    "subject": "Add --capture-output option to glance-control.",
    "status": "MERGED",
    "created": "2012-01-27 18:31:52.000000000",
    "updated": "2012-02-02 23:18:40.000000000",
    "submitted": "2012-02-02 23:17:50.000000000",
    "submitter": {
        "_account_id": 3,
        "name": "Jenkins",
        "username": "jenkins"
    },
    "insertions": 72,
    "deletions": 20,
    "total_comment_count": 1,
    "unresolved_comment_count": 0,
    "has_review_started": true,
    "meta_rev_id": "619d862c16fe336f03872299b03ab17e88cae7c2",
    "_number": 3516,
    "owner": {
        "_account_id": 2284,
        "name": "Eoghan Glynn",
        "email": "eglynn@redhat.com",
        "username": "eglynn"
    },
    "labels": {
        "Verified": {
            "recommended": {
                "_account_id": 3,
                "name": "Jenkins",
                "username": "jenkins"
            },
            "all": [
                {
                    "value": 0,
                    "_account_id": 2284,
                    "name": "Eoghan Glynn",
                    "email": "eglynn@redhat.com",
                    "username": "eglynn"
                },
                {
                    "value": 0,
                    "_account_id": 360,
                    "name": "Dan Prince",
                    "email": "dprince@redhat.com",
                    "username": "dan-prince"
                },
                {
                    "value": 0,
                    "_account_id": 1812,
                    "name": "p-draigbrady",
                    "email": "P@draigBrady.com",
                    "username": "p-draigbrady"
                },
                {
                    "value": 0,
                    "_account_id": 2166,
                    "name": "SmokeStack CI",
                    "username": "smokestack",
                    "tags": [
                        "SERVICE_USER"
                    ]
                },
                {
                    "value": 0,
                    "_account_id": 518,
                    "name": "Soren Hansen",
                    "email": "soren@linux2go.dk",
                    "username": "soren"
                },
                {
                    "value": 0,
                    "_account_id": 679,
                    "name": "Kevin L. Mitchell",
                    "email": "klmitch@mit.edu",
                    "username": "klmitch"
                },
                {
                    "value": 0,
                    "_account_id": 7,
                    "name": "Jay Pipes",
                    "email": "jaypipes@gmail.com",
                    "username": "jaypipes"
                },
                {
                    "value": 1,
                    "date": "2012-02-02 23:17:50.000000000",
                    "_account_id": 3,
                    "name": "Jenkins",
                    "username": "jenkins"
                }
            ],
            "values": {
                "-2": "Fails",
                "-1": "Doesn't seem to work",
                " 0": "No score",
                "+1": "Works for me",
                "+2": "Verified"
            },
            "description": "",
            "value": 1,
            "default_value": 0,
            "optional": true
        },
        "Code-Review": {
            "approved": {
                "_account_id": 679,
                "name": "Kevin L. Mitchell",
                "email": "klmitch@mit.edu",
                "username": "klmitch"
            },
            "all": [
                {
                    "value": 0,
                    "_account_id": 2284,
                    "name": "Eoghan Glynn",
                    "email": "eglynn@redhat.com",
                    "username": "eglynn"
                },
                {
                    "value": 0,
                    "_account_id": 360,
                    "name": "Dan Prince",
                    "email": "dprince@redhat.com",
                    "username": "dan-prince"
                },
                {
                    "value": 0,
                    "_account_id": 1812,
                    "name": "p-draigbrady",
                    "email": "P@draigBrady.com",
                    "username": "p-draigbrady"
                },
                {
                    "value": 0,
                    "_account_id": 2166,
                    "name": "SmokeStack CI",
                    "username": "smokestack",
                    "tags": [
                        "SERVICE_USER"
                    ]
                },
                {
                    "value": 0,
                    "_account_id": 518,
                    "name": "Soren Hansen",
                    "email": "soren@linux2go.dk",
                    "username": "soren"
                },
                {
                    "value": 2,
                    "date": "2012-02-02 23:04:28.000000000",
                    "_account_id": 679,
                    "name": "Kevin L. Mitchell",
                    "email": "klmitch@mit.edu",
                    "username": "klmitch"
                },
                {
                    "value": 2,
                    "date": "2012-02-02 23:03:30.000000000",
                    "_account_id": 7,
                    "name": "Jay Pipes",
                    "email": "jaypipes@gmail.com",
                    "username": "jaypipes"
                },
                {
                    "value": 0,
                    "date": "2012-02-02 23:17:50.000000000",
                    "permitted_voting_range": {
                        "min": 0,
                        "max": 1
                    },
                    "_account_id": 3,
                    "name": "Jenkins",
                    "username": "jenkins"
                }
            ],
            "values": {
                "-2": "Do not merge",
                "-1": "This patch needs further work before it can be merged",
                " 0": "No score",
                "+1": "Looks good to me, but someone else must approve",
                "+2": "Looks good to me (core reviewer)"
            },
            "description": "",
            "default_value": 0,
            "optional": true
        },
        "Workflow": {
            "approved": {
                "_account_id": 7,
                "name": "Jay Pipes",
                "email": "jaypipes@gmail.com",
                "username": "jaypipes"
            },
            "all": [
                {
                    "value": 0,
                    "_account_id": 2284,
                    "name": "Eoghan Glynn",
                    "email": "eglynn@redhat.com",
                    "username": "eglynn"
                },
                {
                    "value": 0,
                    "_account_id": 360,
                    "name": "Dan Prince",
                    "email": "dprince@redhat.com",
                    "username": "dan-prince"
                },
                {
                    "value": 0,
                    "_account_id": 1812,
                    "name": "p-draigbrady",
                    "email": "P@draigBrady.com",
                    "username": "p-draigbrady"
                },
                {
                    "value": 0,
                    "_account_id": 2166,
                    "name": "SmokeStack CI",
                    "username": "smokestack",
                    "tags": [
                        "SERVICE_USER"
                    ]
                },
                {
                    "value": 0,
                    "_account_id": 518,
                    "name": "Soren Hansen",
                    "email": "soren@linux2go.dk",
                    "username": "soren"
                },
                {
                    "value": 0,
                    "date": "2012-02-02 23:04:28.000000000",
                    "_account_id": 679,
                    "name": "Kevin L. Mitchell",
                    "email": "klmitch@mit.edu",
                    "username": "klmitch"
                },
                {
                    "value": 1,
                    "date": "2012-02-02 23:12:14.000000000",
                    "_account_id": 7,
                    "name": "Jay Pipes",
                    "email": "jaypipes@gmail.com",
                    "username": "jaypipes"
                },
                {
                    "value": 0,
                    "_account_id": 3,
                    "name": "Jenkins",
                    "username": "jenkins"
                }
            ],
            "values": {
                "-1": "Work in progress",
                " 0": "Ready for reviews",
                "+1": "Approved"
            },
            "description": "",
            "default_value": 0,
            "optional": true
        },
        "Review-Priority": {
            "all": [
                {
                    "value": 0,
                    "_account_id": 2284,
                    "name": "Eoghan Glynn",
                    "email": "eglynn@redhat.com",
                    "username": "eglynn"
                },
                {
                    "value": 0,
                    "_account_id": 360,
                    "name": "Dan Prince",
                    "email": "dprince@redhat.com",
                    "username": "dan-prince"
                },
                {
                    "value": 0,
                    "_account_id": 1812,
                    "name": "p-draigbrady",
                    "email": "P@draigBrady.com",
                    "username": "p-draigbrady"
                },
                {
                    "value": 0,
                    "_account_id": 2166,
                    "name": "SmokeStack CI",
                    "username": "smokestack",
                    "tags": [
                        "SERVICE_USER"
                    ]
                },
                {
                    "value": 0,
                    "_account_id": 518,
                    "name": "Soren Hansen",
                    "email": "soren@linux2go.dk",
                    "username": "soren"
                },
                {
                    "value": 0,
                    "_account_id": 679,
                    "name": "Kevin L. Mitchell",
                    "email": "klmitch@mit.edu",
                    "username": "klmitch"
                },
                {
                    "value": 0,
                    "_account_id": 7,
                    "name": "Jay Pipes",
                    "email": "jaypipes@gmail.com",
                    "username": "jaypipes"
                },
                {
                    "value": 0,
                    "_account_id": 3,
                    "name": "Jenkins",
                    "username": "jenkins"
                }
            ],
            "values": {
                "-1": "Branch Freeze",
                " 0": "No Priority",
                "+1": "Important Change",
                "+2": "Top Priority / Holds Gate"
            },
            "description": "",
            "default_value": 0,
            "optional": true
        }
    },
    "removable_reviewers": [],
    "reviewers": {
        "REVIEWER": [
            {
                "_account_id": 3,
                "name": "Jenkins",
                "username": "jenkins"
            },
            {
                "_account_id": 7,
                "name": "Jay Pipes",
                "email": "jaypipes@gmail.com",
                "username": "jaypipes"
            },
            {
                "_account_id": 360,
                "name": "Dan Prince",
                "email": "dprince@redhat.com",
                "username": "dan-prince"
            },
            {
                "_account_id": 518,
                "name": "Soren Hansen",
                "email": "soren@linux2go.dk",
                "username": "soren"
            },
            {
                "_account_id": 679,
                "name": "Kevin L. Mitchell",
                "email": "klmitch@mit.edu",
                "username": "klmitch"
            },
            {
                "_account_id": 1812,
                "name": "p-draigbrady",
                "email": "P@draigBrady.com",
                "username": "p-draigbrady"
            },
            {
                "_account_id": 2166,
                "name": "SmokeStack CI",
                "username": "smokestack",
                "tags": [
                    "SERVICE_USER"
                ]
            },
            {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            }
        ]
    },
    "pending_reviewers": {},
    "reviewer_updates": [
        {
            "updated": "2012-01-28 17:35:25.000000000",
            "updated_by": {
                "_account_id": 360,
                "name": "Dan Prince",
                "email": "dprince@redhat.com",
                "username": "dan-prince"
            },
            "reviewer": {
                "_account_id": 360,
                "name": "Dan Prince",
                "email": "dprince@redhat.com",
                "username": "dan-prince"
            },
            "state": "REVIEWER"
        },
        {
            "updated": "2012-01-30 12:43:33.000000000",
            "updated_by": {
                "_account_id": 518,
                "name": "Soren Hansen",
                "email": "soren@linux2go.dk",
                "username": "soren"
            },
            "reviewer": {
                "_account_id": 518,
                "name": "Soren Hansen",
                "email": "soren@linux2go.dk",
                "username": "soren"
            },
            "state": "REVIEWER"
        },
        {
            "updated": "2012-01-31 19:46:31.000000000",
            "updated_by": {
                "_account_id": 2166,
                "name": "SmokeStack CI",
                "username": "smokestack",
                "tags": [
                    "SERVICE_USER"
                ]
            },
            "reviewer": {
                "_account_id": 2166,
                "name": "SmokeStack CI",
                "username": "smokestack",
                "tags": [
                    "SERVICE_USER"
                ]
            },
            "state": "REVIEWER"
        },
        {
            "updated": "2012-01-31 22:09:23.000000000",
            "updated_by": {
                "_account_id": 1812,
                "name": "p-draigbrady",
                "email": "P@draigBrady.com",
                "username": "p-draigbrady"
            },
            "reviewer": {
                "_account_id": 1812,
                "name": "p-draigbrady",
                "email": "P@draigBrady.com",
                "username": "p-draigbrady"
            },
            "state": "REVIEWER"
        },
        {
            "updated": "2012-02-02 23:04:28.000000000",
            "updated_by": {
                "_account_id": 679,
                "name": "Kevin L. Mitchell",
                "email": "klmitch@mit.edu",
                "username": "klmitch"
            },
            "reviewer": {
                "_account_id": 679,
                "name": "Kevin L. Mitchell",
                "email": "klmitch@mit.edu",
                "username": "klmitch"
            },
            "state": "REVIEWER"
        },
        {
            "updated": "2012-02-02 23:12:14.000000000",
            "updated_by": {
                "_account_id": 7,
                "name": "Jay Pipes",
                "email": "jaypipes@gmail.com",
                "username": "jaypipes"
            },
            "reviewer": {
                "_account_id": 7,
                "name": "Jay Pipes",
                "email": "jaypipes@gmail.com",
                "username": "jaypipes"
            },
            "state": "REVIEWER"
        },
        {
            "updated": "2012-02-02 23:17:50.000000000",
            "updated_by": {
                "_account_id": 3,
                "name": "Jenkins",
                "username": "jenkins"
            },
            "reviewer": {
                "_account_id": 3,
                "name": "Jenkins",
                "username": "jenkins"
            },
            "state": "REVIEWER"
        }
    ],
    "messages": [
        {
            "id": "550a209d8d12641a5ed98cb939c39345726b55a9",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-01-27 23:37:54.000000000",
            "message": "Uploaded patch set 2.",
            "accounts_in_message": [],
            "_revision_number": 2
        },
        {
            "id": "12acf2d6cf27834fa4fab931087170a33395bc0e",
            "author": {
                "_account_id": 360,
                "name": "Dan Prince",
                "email": "dprince@redhat.com",
                "username": "dan-prince"
            },
            "real_author": {
                "_account_id": 360,
                "name": "Dan Prince",
                "email": "dprince@redhat.com",
                "username": "dan-prince"
            },
            "date": "2012-01-28 17:35:25.000000000",
            "message": "Patch Set 2:\n\nEoghan,\n\nAny idea why this branch might hang the unit test runners on SmokeStack?",
            "accounts_in_message": [],
            "_revision_number": 2
        },
        {
            "id": "77af0f09e4ea02eff4ca0e0de1dc3e400fe1a862",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-01-29 17:10:34.000000000",
            "message": "Patch Set 2:\n\nDan - the test hang seems to be Ubuntu-specific. I originally developed and tested the patch on Fedora-16, where the suite runs to completion.\n\nI suspect some distro-specifics in the underpinnings of subprocess.Popen(), which is used in this patch to spwan /usr/bin/logger in order to capture the glance API & registry service stsdout/err via syslogd.\n\nI've reproduced the hang on Ubuntu 10.04, and will work on a solution before submitting a patch set 2.",
            "accounts_in_message": [],
            "_revision_number": 2
        },
        {
            "id": "00f301773fe27a1936d1002f4259c84779293503",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-01-30 00:11:49.000000000",
            "message": "Uploaded patch set 3.",
            "accounts_in_message": [],
            "_revision_number": 3
        },
        {
            "id": "c2cee36b46863cfca74b01c44209913e00fbed9d",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-01-30 00:21:03.000000000",
            "message": "Patch Set 3:\n\nPatch set 3 resolves test suite hang on Ubuntu by replacing problematic Popen.communicate() call in test utility code with:\n\n- explicit reads from piped stdout gated on select to avoid blocking\n\n- a finite sequence of Popen.poll() calls before bailing on a clean subprocess termination.",
            "accounts_in_message": [],
            "_revision_number": 3
        },
        {
            "id": "280ca44835af43258d6d60679c4b19c433167b42",
            "author": {
                "_account_id": 2166,
                "name": "SmokeStack CI",
                "username": "smokestack",
                "tags": [
                    "SERVICE_USER"
                ]
            },
            "real_author": {
                "_account_id": 2166,
                "name": "SmokeStack CI",
                "username": "smokestack",
                "tags": [
                    "SERVICE_USER"
                ]
            },
            "date": "2012-01-30 03:31:33.000000000",
            "message": "Patch Set 3:\n\nSmokeStack Results (patch set 3):\n\tUnit Success: http://smokestack.openstack.org/?go=/jobs/10534\n\tLibvirt Success: http://smokestack.openstack.org/?go=/jobs/10535\n\tXenServer Success: http://smokestack.openstack.org/?go=/jobs/10533",
            "accounts_in_message": [],
            "_revision_number": 3
        },
        {
            "id": "e874530016c91e8f848ffc433ced7e8ccfd223fb",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-01-30 10:14:44.000000000",
            "message": "Uploaded patch set 4.",
            "accounts_in_message": [],
            "_revision_number": 4
        },
        {
            "id": "fa8882317eea017a691769672c377dfe17e28039",
            "author": {
                "_account_id": 518,
                "name": "Soren Hansen",
                "email": "soren@linux2go.dk",
                "username": "soren"
            },
            "real_author": {
                "_account_id": 518,
                "name": "Soren Hansen",
                "email": "soren@linux2go.dk",
                "username": "soren"
            },
            "date": "2012-01-30 12:43:33.000000000",
            "message": "Patch Set 4:\n\nSorry for being such a stick in the mud, but I'm really not comfortable applying workarounds to problems we don't understand. Can you come up with a small script that reproduces that hang on Ubuntu so that I can look into what might be causing it?",
            "accounts_in_message": [],
            "_revision_number": 4
        },
        {
            "id": "c1b9f109ce9bfe680ac0f2eb048a97aaf2a013af",
            "author": {
                "_account_id": 2166,
                "name": "SmokeStack CI",
                "username": "smokestack",
                "tags": [
                    "SERVICE_USER"
                ]
            },
            "real_author": {
                "_account_id": 2166,
                "name": "SmokeStack CI",
                "username": "smokestack",
                "tags": [
                    "SERVICE_USER"
                ]
            },
            "date": "2012-01-30 13:11:08.000000000",
            "message": "Patch Set 4:\n\nSmokeStack Results (patch set 4):\n\tUnit Success: http://smokestack.openstack.org/?go=/jobs/10544\n\tLibvirt Success: http://smokestack.openstack.org/?go=/jobs/10542\n\tXenServer Success: http://smokestack.openstack.org/?go=/jobs/10543",
            "accounts_in_message": [],
            "_revision_number": 4
        },
        {
            "id": "77fb037c530ace0ac449d50db676c7a00e5248bb",
            "author": {
                "_account_id": 7,
                "name": "Jay Pipes",
                "email": "jaypipes@gmail.com",
                "username": "jaypipes"
            },
            "real_author": {
                "_account_id": 7,
                "name": "Jay Pipes",
                "email": "jaypipes@gmail.com",
                "username": "jaypipes"
            },
            "date": "2012-01-30 14:50:26.000000000",
            "message": "Patch Set 4:\n\nHi Eoghan!\n\nIs there a bug report that this should be tied to? Also, does https://answers.launchpad.net/glance/+question/186251 have anything to do with this?\n\nThanks!\n-jay",
            "accounts_in_message": [],
            "_revision_number": 4
        },
        {
            "id": "bd752702bf2a4405d6484e89178d0cb34718044e",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-01-30 19:07:47.000000000",
            "message": "Patch Set 4:\n\nHi Jay,\n\nI just reported a bug for this feature:\n\nhttps://bugs.launchpad.net/glance/+bug/923894\n\nI don't think the hang previously observed on Ubuntu test runs is related to that issue you mentioned. The hang was only seen during test runs (not when glance-control/glance-api were launched manually), and occurred in the test utility code used to spawn glance-control (not within glance-control itself).\n\nI suspect the issue may be related to the hierarchy of subprocesses launched via Popen from nose->glance-control->glance-api->/usr/bin/logger, and the way EOFs on pipes are detected. However I haven't narrowed it down further.\n\nThe work-around in patch set 3 allows the tests run to completion on both Fedora and Ubuntu.\n\n\nHi Soren,\n\nThanks for the feedback - I will strive to reproduce the test hang with a minimal testcase.\n\nCheers,\nEoghan",
            "accounts_in_message": [],
            "_revision_number": 4
        },
        {
            "id": "0f11fc4941aca89b5e9ebf76342e7cc1b954e692",
            "author": {
                "_account_id": 1812,
                "name": "p-draigbrady",
                "email": "P@draigBrady.com",
                "username": "p-draigbrady"
            },
            "real_author": {
                "_account_id": 1812,
                "name": "p-draigbrady",
                "email": "P@draigBrady.com",
                "username": "p-draigbrady"
            },
            "date": "2012-01-30 22:53:21.000000000",
            "message": "Patch Set 4:\n\nThe manual scan with timeout looks too hacky to me.\nWhen hung one might get the process that's hung using `pstree -p` and then `strace -p` on that to see if it's blocked reading or writing.\n\nThis bit of execute() looks a bit strange:\n  stdin=subprocess.PIPE\nprocess.stdin is not connected anywhere though.\nSo I would suggest that process.stdin.close() is\ncalled before process.communicate()\n\nIf that doesn't fix, then I'd try adding the close_fds=True\nparam to the Popen constructor in case descriptors leaking into the children are causing adverse effects.",
            "accounts_in_message": [],
            "_revision_number": 4
        },
        {
            "id": "27c2d2110e7c3335e6188a49338319ae8f046a42",
            "author": {
                "_account_id": 1812,
                "name": "p-draigbrady",
                "email": "P@draigBrady.com",
                "username": "p-draigbrady"
            },
            "real_author": {
                "_account_id": 1812,
                "name": "p-draigbrady",
                "email": "P@draigBrady.com",
                "username": "p-draigbrady"
            },
            "date": "2012-01-30 23:22:31.000000000",
            "message": "Patch Set 4:\n\nJust in case, these might also be worth investigating:\n\nhttp://thraxil.org/users/anders/posts/2008/03/13/Subprocess-Hanging-PIPE-is-your-enemy/\nhttp://bugs.python.org/issue4216#msg77582\n\nNote lucid is on python 2.6 while Fedora is on 2.7,\nso perhaps something got fixed in the meantime.\n\nUnfortunately I use my own subprocess wrapper\n(upon which the official python one was based),\nso never noticed any of these implementation issues.",
            "accounts_in_message": [],
            "_revision_number": 4
        },
        {
            "id": "9c446776cffcd648c9313bddcbeed0caa654885c",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-01-31 14:09:49.000000000",
            "message": "Patch Set 4:\n\nHi P\u00e1draig,\n\nThanks for the feedback and tips!\n\nHowever I don't think either of the two leads you mention are relevant.\n\nThe problematic subprocess.Popen() call deliberately doesn't create a pipe to stdin, only stdout:\n\n  process = subprocess.Popen(cmd,\n                             shell=True,\n                             stdout=subprocess.PIPE,\n                             env=env)\n\nYour other lead refers to stdio buffer exhaustion causing a hang, whereas glance-control only ever produces a few lines of text output, so it would never make a dent in a 64k buffer.\n\nNow I'm really probing the edges of my Linux knowledge, but here's my current working theory ...\n\nThe relevant process interactions are as follows:\n\nhttp://www.pastie.org/pastes/3288892/text\n\n(pasted to avoid the ascii 'art' being mangled)\n\nwhere T is test utils, GC is glance-control, P1 is glance-control's piped stdout, SL is sys logger and GA is glance-api.\n\nIt's the TU read call on P1 that's hanging *after* the parent GC process has exited.\n\nOn Fedora this read is interrupted on the child's death so the test run is unblocked. \n\nOn Ubuntu, I'm seeing the initial read call return with ERESTARTSYS when the SIGCHLD is raised for the dead GC parent process, which causes the read to be restarted and block the test run.\n\nThe fact that ERESTARTSYS is thrown on Ubuntu and not on Fedora may be due to the WNOHANG flag being set on the relevant wait() call in the letter case. On Ubuntu, the dead GC parent process is reported as a zombie, suggesting its not even being wait()ed upon.\n\nSo hacky as the alternative approach in the test utils may seem, it does avoid that restarted read (which appears wrong under the circumstances).\n\nThoughts?\n\nCheers,\nEoghan",
            "accounts_in_message": [],
            "_revision_number": 4
        },
        {
            "id": "779cb74eedda641ead17a333e3e2d00fe4997f2c",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-01-31 14:28:41.000000000",
            "message": "Patch Set 4:\n\nActually that ERESTARTSYS may just be an artifact of the process  running with strace attached (as opposed to being caused by the SIGCHLD).",
            "accounts_in_message": [],
            "_revision_number": 4
        },
        {
            "id": "aa2e209460ee36b648a4c29b5495d5e3d2c71e37",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-01-31 16:14:26.000000000",
            "message": "Patch Set 4:\n\nHi Soren,\n\nAs requested, here's a minimal script reproducing the hang in the test utility logic.\n\n$ wget https://s3.amazonaws.com/eglynn-tests/hung_pipe.tar.gz\n$ tar xzf hung_pipe.tar.gz\n$ python a.py      # ... runs to completion\n$ python a.py hang # ... hangs on read from pipe\n\nUsing strace, you can clearly see the ERESTARTED behaviour refered to in previous comments, e.g.:\n\nNon-hanging case where the child death leads to the read on the stdout pipe in a.py to be closed:\n\nread(5, \"exiting\\n\", 8192)              = 8\nread(5, \"\", 8184)                       = 0\n--- SIGCHLD (Child exited) @ 0 (0) ---\nclose(5)                                = 0\nwait4(11815, [{WIFEXITED(s) && WEXITSTATUS(s) == 0}], 0, NULL) = 11815\n...etc.\n\nHanging case where read is restarted just as the SIGCHLD is received to indicate the piped process has died:\n\nread(5, \"exiting\\n\", 8192)              = 8\nread(5, 0x288b6ec, 8184)                = ? ERESTARTSYS (To be restarted)\n--- SIGCHLD (Child exited) @ 0 (0) ---\nread(5, \n\nIntestingly with this stripped-down test case, I can reproduce the hang on both Ubuntu 10.04 and Fedora 16.",
            "accounts_in_message": [],
            "_revision_number": 4
        },
        {
            "id": "3a0866fa4219bd202ad6db91752a3f89adb40285",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-01-31 17:51:11.000000000",
            "message": "Patch Set 4:\n\nAfter finally taking proper notice of the slightly munged link in p-draigbrady's comment above:\n\nhttp://bugs.python.org/issue4216#msg77582\n\nI've set the close-on-exec flag explicitly on stdio FDs in glance-control to avoid the test utility code blocking on input from the grandchild process.\n\nSo the tests can run to completion on Ubuntu and Fedora without the test utils work-around (that gave the earlier reviewers pause).\n\nI'll submit a cleaned-up patch set 5 presently ...",
            "accounts_in_message": [],
            "_revision_number": 4
        },
        {
            "id": "a282ebb32905b1ebb11a7d542acbd535a2fa6e9f",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-01-31 18:27:57.000000000",
            "message": "Uploaded patch set 5.",
            "accounts_in_message": [],
            "_revision_number": 5
        },
        {
            "id": "3905a00679de12c46c651573856c95cc9af38591",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-01-31 18:36:32.000000000",
            "message": "Uploaded patch set 6.",
            "accounts_in_message": [],
            "_revision_number": 6
        },
        {
            "id": "c0e621bb7bc651aee712ec3563cac1133bc96067",
            "author": {
                "_account_id": 2166,
                "name": "SmokeStack CI",
                "username": "smokestack",
                "tags": [
                    "SERVICE_USER"
                ]
            },
            "real_author": {
                "_account_id": 2166,
                "name": "SmokeStack CI",
                "username": "smokestack",
                "tags": [
                    "SERVICE_USER"
                ]
            },
            "date": "2012-01-31 19:46:31.000000000",
            "message": "Patch Set 6:\n\nSmokeStack Results (patch set 6):\n\tUnit Success: http://smokestack.openstack.org/?go=/jobs/10675\n\tLibvirt Success: http://smokestack.openstack.org/?go=/jobs/10673\n\tXenServer Success: http://smokestack.openstack.org/?go=/jobs/10676",
            "accounts_in_message": [],
            "_revision_number": 6
        },
        {
            "id": "a27742ddfba5442efb0f2c5ec00d4c3ab327a4ae",
            "author": {
                "_account_id": 1812,
                "name": "p-draigbrady",
                "email": "P@draigBrady.com",
                "username": "p-draigbrady"
            },
            "real_author": {
                "_account_id": 1812,
                "name": "p-draigbrady",
                "email": "P@draigBrady.com",
                "username": "p-draigbrady"
            },
            "date": "2012-01-31 22:09:23.000000000",
            "message": "Patch Set 6: Looks good to me, but someone else must approve\n\n",
            "accounts_in_message": [],
            "_revision_number": 6
        },
        {
            "id": "4f4bef528cf532176ee69254cc351fb825cbcad4",
            "author": {
                "_account_id": 679,
                "name": "Kevin L. Mitchell",
                "email": "klmitch@mit.edu",
                "username": "klmitch"
            },
            "real_author": {
                "_account_id": 679,
                "name": "Kevin L. Mitchell",
                "email": "klmitch@mit.edu",
                "username": "klmitch"
            },
            "date": "2012-02-01 21:15:26.000000000",
            "message": "Patch Set 6: Looks good to me (core reviewer)\n\n",
            "accounts_in_message": [],
            "_revision_number": 6
        },
        {
            "id": "a38bc2af451a7e72631372d675d8f06c57d24286",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-02-02 18:44:38.000000000",
            "message": "Patch Set 6:\n\nThis patch needs a slightly messy rebase to account for:\n\nhttps://review.openstack.org/#change,3670\n\nPlease hold off +2'ing until I submit a rebased patch set.",
            "accounts_in_message": [],
            "_revision_number": 6
        },
        {
            "id": "84f19cc3b5d74cd4812cdd401e98915e46bda788",
            "author": {
                "_account_id": 679,
                "name": "Kevin L. Mitchell",
                "email": "klmitch@mit.edu",
                "username": "klmitch"
            },
            "real_author": {
                "_account_id": 679,
                "name": "Kevin L. Mitchell",
                "email": "klmitch@mit.edu",
                "username": "klmitch"
            },
            "date": "2012-02-02 18:51:09.000000000",
            "message": "Patch Set 6: I would prefer that you didn't submit this\n\nNeeds a rebase",
            "accounts_in_message": [],
            "_revision_number": 6
        },
        {
            "id": "f80ac3ff8d9c6f43d9200c95733e1da5d95b4901",
            "author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "real_author": {
                "_account_id": 2284,
                "name": "Eoghan Glynn",
                "email": "eglynn@redhat.com",
                "username": "eglynn"
            },
            "date": "2012-02-02 23:00:51.000000000",
            "message": "Uploaded patch set 7.",
            "accounts_in_message": [],
            "_revision_number": 7
        },
        {
            "id": "8db1ef94609493895458f1db9e283b382d3e58e9",
            "author": {
                "_account_id": 7,
                "name": "Jay Pipes",
                "email": "jaypipes@gmail.com",
                "username": "jaypipes"
            },
            "real_author": {
                "_account_id": 7,
                "name": "Jay Pipes",
                "email": "jaypipes@gmail.com",
                "username": "jaypipes"
            },
            "date": "2012-02-02 23:03:30.000000000",
            "message": "Patch Set 7: Looks good to me (core reviewer)\n\nlgtm.",
            "accounts_in_message": [],
            "_revision_number": 7
        },
        {
            "id": "eb79e51e381584c98fad6976e5a242d03f56401a",
            "author": {
                "_account_id": 679,
                "name": "Kevin L. Mitchell",
                "email": "klmitch@mit.edu",
                "username": "klmitch"
            },
            "real_author": {
                "_account_id": 679,
                "name": "Kevin L. Mitchell",
                "email": "klmitch@mit.edu",
                "username": "klmitch"
            },
            "date": "2012-02-02 23:04:28.000000000",
            "message": "Patch Set 7: Looks good to me (core reviewer)\n\n(1 inline comment)\n\n",
            "accounts_in_message": [],
            "_revision_number": 7
        },
        {
            "id": "341370995ee2159db9caa82d513345248458825e",
            "author": {
                "_account_id": 7,
                "name": "Jay Pipes",
                "email": "jaypipes@gmail.com",
                "username": "jaypipes"
            },
            "real_author": {
                "_account_id": 7,
                "name": "Jay Pipes",
                "email": "jaypipes@gmail.com",
                "username": "jaypipes"
            },
            "date": "2012-02-02 23:12:14.000000000",
            "message": "Patch Set 7: Approved\n\noff it goes then...",
            "accounts_in_message": [],
            "_revision_number": 7
        },
        {
            "id": "bc66e2e85210c2b76dade2b6bff5da5c5ffe518e",
            "author": {
                "_account_id": 3,
                "name": "Jenkins",
                "username": "jenkins"
            },
            "real_author": {
                "_account_id": 3,
                "name": "Jenkins",
                "username": "jenkins"
            },
            "date": "2012-02-02 23:17:50.000000000",
            "message": "Patch Set 7: Verified\n\nBuild Successful \n \nhttps://jenkins.openstack.org/job/gate-glance-unittests/89506/ : SUCCESS \nhttps://jenkins.openstack.org/job/gate-integration-tests-devstack-vm/1068/ : SUCCESS \nhttps://jenkins.openstack.org/job/gate-glance-merge/330/ : SUCCESS \nhttps://jenkins.openstack.org/job/gate-glance-pep8/505/ : SUCCESS",
            "accounts_in_message": [],
            "_revision_number": 7
        },
        {
            "id": "2bafba4de7ffda6b36c516d50edaff4da779559f",
            "author": {
                "_account_id": 3,
                "name": "Jenkins",
                "username": "jenkins"
            },
            "real_author": {
                "_account_id": 3,
                "name": "Jenkins",
                "username": "jenkins"
            },
            "date": "2012-02-02 23:17:51.000000000",
            "message": "Change has been successfully merged into the git repository.",
            "accounts_in_message": [],
            "_revision_number": 7
        },
        {
            "id": "619d862c16fe336f03872299b03ab17e88cae7c2",
            "author": {
                "_account_id": 3,
                "name": "Jenkins",
                "username": "jenkins"
            },
            "real_author": {
                "_account_id": 3,
                "name": "Jenkins",
                "username": "jenkins"
            },
            "date": "2012-02-02 23:18:40.000000000",
            "message": "Patch Set 7:\n\nBuild Successful \n \nhttps://jenkins.openstack.org/job/glance-tarball/352/ : SUCCESS",
            "accounts_in_message": [],
            "_revision_number": 7
        }
    ],
    "requirements": [],
    "submit_records": []
}